= CloudFoundry Migration tool
Budi Darmawan <vbudi@us.ibm.com>
v1.0 2019-07-10
:toc:
:imagesdir: ../../assets/images

This tool assists you in migrating CloudFoundry applications to Kubernetes based platforms, such as OpenShift, IBM Kubernetes Service (IKS) and IBM Cloud Private (ICP).

== Migration tool approach

The migration tool is not designed to provide a fully automated conversion of the application from Cloud Foundry to Kubernetes. It uses the source code and the environment variables from the running Cloud Foundry application to generate all the necessary assets to deploy that application to a  Kubernetes platform. However, the tool does require several commands to be run by the user. It is important for the user of the tool to understand the differences between Cloud Foundry and Kubernetes, and the general tasks required to migrate from one to the other. The manual steps required by the tool are meant to help the user understand this process.

The configuration files and other assets generated by  the tool can be used to test and deploy the application to Kubernetes. They can also be used later to help create an automated DevOps pipeline for follow-on application maintenance. The tool is only meant to be run once to migrate a given application. The goal is that once the application is running in Kubernetes, any follow-on maintenance is performed on that platform.

The assets generated by the tool vary by application language and type, but are typically:

- Binaries and configuration files for the application code
- A Dockerfile to generate the application container image
- YAML configuration files to deploy to Kubernetes

== Using the migration tool

The tool is packaged in a GitHub repository at [this link](https://github.com/ibm-cloud-architecture/cf-transformation). A sample Java application is provided in the `exemplar` sub-directory. This tool requires the following pre-requisite software to be installed on your system:

- bash
- docker
- jq
- Java Development Kit
- git
- curl
- xmlstarlet
- maven
- gradle

You can also run the tool using a provided Docker container. This allows you to run the tool without installing the prerequisite software on your system.
Using a docker container allows you to run the tool without having to install all the prerequisite software on your own machine.
This docker container will share the host docker environment to run `docker` command.
Assuming that you have docker running, do the following steps to run the migration tool from the container:


1. Get the container image:

                docker pull ibmcloudacademy/cfmigrationtool

2. In the command to start the container, provide the path to an existing directory on your machine that the tool will use for its conversion and to store the output. The following example assumes that you are using `/Users/ibmuser/data`:

                docker run -p 8000:8000 -v /Users/ibmuser/data:/data -v /var/run/docker.sock:/var/run/docker.sock -it ibmcloudacademy/cfmigrationtool bash

3. You will get a bash prompt from inside the container. You can then perform the migration tasks listed in the documentation and exercises. Since the directory you provided in the previous command is mapped to the path `/data` inside the container, remember to use the path `/data` as your target path (the `-t` parameter for the `cf-migrate.sh` script)

4. You can now clone the migration tool from git:

                git clone https://github.com/ibm-cloud-architecture/cf-transformation

5. Change the directory to the `migrate` sub-directory:

		cd cf-transformation/migrate

6. Get the content of your application's VCAP_SERVICES environment variables from Cloud Foundry. Most importantly, these variables contain the names, descriptions, and credentials required to access any backend services used by the application:

		cf env <appname> | awk '/VCAP_SERVICES/{flag=1} /^}/{flag=0} flag' | sed 's/"VCAP_SERVICES"://' > vcap.json

7. Run the migration tool against your application source code:

		./cf-migrate.sh -s <source> -t <tempdir> -b <app type> -e <target type>

	Where:

	- `-s` Source path or git repository URL
	- `-t` Temporary conversion directory where the work will be performed and output will be generated (default: /tmp/convdir)
	- `-b` Application type (Cloud Foundry buildpack), such as ibm-websphere-liberty, java, or nodejs
	- `-e` Target environment: openshift, iks or icp


To be able to successfully perform the migration, you will need:

- docker installed and running
- Account and Command Line Interface (CLI) access to the kubernetes environment (kubectl for IKS, oc for OpenShift)
- Account and CLI access to the Cloud Foundry environment

== Migration tool output

The typical user output from a migration tool run is shown below:

image::toolrun.PNG[]

The tool produces an HTML file called `result.html` in the conversion directory. This provides step-by-step instructions for deploying your application to Kubernetes:

image::result.PNG[]

For an example of running the migration tool, you can see the following videos for examples:

- https://ibm.ent.box.com/s/2am8zymeqpdma5bxy6cbw8znforxced0[Simple Liberty app]
- https://ibm.ent.box.com/s/soojmwu85m640fz14p86dc0492ad9s2q[NodeJS app with Cloudant backend]

== Migration tool limitation

The following limitation existed in this version of the tool:

- Only support gradle or maven as the build mechanism
- Limited logic to manage complex application (ie multiple war files or non npm based nodejs)
- Liberty apps must already have the DataSource and JDBC definition in server.xml file
        - Will not build a JDBC structure in server.xml
- Must manually supply a VCAP_SERVICES environment variable value
        - The command is provided in documentation
